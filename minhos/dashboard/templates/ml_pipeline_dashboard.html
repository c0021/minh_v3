{% extends "base.html" %}

{% block title %}ML Pipeline Dashboard - MinhOS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/ml-performance.css') }}">
<style>
.ml-pipeline-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.ml-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
}

.ml-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.ml-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid;
}

.ml-card.status { border-left-color: #4CAF50; }
.ml-card.performance { border-left-color: #2196F3; }
.ml-card.alerts { border-left-color: #FF9800; }
.ml-card.activity { border-left-color: #9C27B0; }

.ml-card h3 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 1.2em;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

.status-item {
    text-align: center;
    padding: 15px;
    border-radius: 8px;
    background: #f8f9fa;
}

.status-item.enabled {
    background: #d4edda;
    color: #155724;
}

.status-item.disabled {
    background: #f8d7da;
    color: #721c24;
}

.status-item.warning {
    background: #fff3cd;
    color: #856404;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.metric-row:last-child {
    border-bottom: none;
}

.metric-label {
    font-weight: 500;
    color: #666;
}

.metric-value {
    font-weight: bold;
    color: #333;
}

.alert-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 6px;
    border-left: 4px solid;
}

.alert-item.error {
    background: #f8d7da;
    border-left-color: #dc3545;
    color: #721c24;
}

.alert-item.warning {
    background: #fff3cd;
    border-left-color: #ffc107;
    color: #856404;
}

.alert-item.info {
    background: #d1ecf1;
    border-left-color: #17a2b8;
    color: #0c5460;
}

.prediction-item {
    padding: 12px;
    margin: 8px 0;
    border-radius: 8px;
    background: #f8f9fa;
    border-left: 4px solid #6c757d;
}

.prediction-item.up {
    border-left-color: #28a745;
    background: #d4edda;
}

.prediction-item.down {
    border-left-color: #dc3545;
    background: #f8d7da;
}

.prediction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.confidence-bar {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 5px;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffc107, #28a745);
    transition: width 0.3s ease;
}

.models-section {
    margin-top: 30px;
}

.models-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.model-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.model-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.model-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: bold;
}

.model-status.enabled {
    background: #d4edda;
    color: #155724;
}

.model-status.disabled {
    background: #f8d7da;
    color: #721c24;
}

.refresh-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: transform 0.2s ease;
}

.refresh-button:hover {
    transform: translateY(-2px);
}

.auto-refresh-indicator {
    font-size: 0.9em;
    color: #666;
    margin-left: 10px;
}

.auto-refresh-indicator.active {
    color: #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="ml-pipeline-container">
    <!-- Header -->
    <div class="ml-header">
        <h1>ü§ñ ML Pipeline Dashboard</h1>
        <p>Real-time monitoring of LSTM, Ensemble, and Kelly Criterion components</p>
        <div style="margin-top: 15px;">
            <button class="refresh-button" onclick="refreshAllData()">
                üîÑ Refresh All
            </button>
            <span class="auto-refresh-indicator" id="autoRefreshStatus">Auto-refresh: OFF</span>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="ml-grid">
        <!-- Status Overview -->
        <div class="ml-card status">
            <h3>üö¶ System Status</h3>
            <div class="status-grid" id="statusOverview">
                <div class="status-item">
                    <div>LSTM</div>
                    <div id="lstmStatus">Loading...</div>
                </div>
                <div class="status-item">
                    <div>Ensemble</div>
                    <div id="ensembleStatus">Loading...</div>
                </div>
                <div class="status-item">
                    <div>Kelly</div>
                    <div id="kellyStatus">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="ml-card performance">
            <h3>üìä Performance Metrics</h3>
            <div id="performanceMetrics">
                <div class="metric-row">
                    <span class="metric-label">Total Predictions</span>
                    <span class="metric-value" id="totalPredictions">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">24h Accuracy</span>
                    <span class="metric-value" id="accuracy24h">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Avg Confidence</span>
                    <span class="metric-value" id="avgConfidence">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Model Agreement</span>
                    <span class="metric-value" id="agreementRate">-</span>
                </div>
            </div>
        </div>

        <!-- Health Alerts -->
        <div class="ml-card alerts">
            <h3>‚ö†Ô∏è Health Alerts</h3>
            <div id="healthAlerts">
                <div class="metric-row">
                    <span class="metric-label">Total Alerts</span>
                    <span class="metric-value" id="totalAlerts">-</span>
                </div>
                <div id="alertsList">Loading...</div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="ml-card activity">
            <h3>üîÑ Recent Activity</h3>
            <div id="recentActivity">
                <div class="metric-row">
                    <span class="metric-label">Last Prediction</span>
                    <span class="metric-value" id="lastPrediction">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Latest Direction</span>
                    <span class="metric-value" id="latestDirection">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Latest Confidence</span>
                    <span class="metric-value" id="latestConfidence">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Predictions -->
    <div class="ml-card">
        <h3>üéØ Recent Predictions</h3>
        <div id="recentPredictions">Loading recent predictions...</div>
    </div>

    <!-- Model Details -->
    <div class="models-section">
        <h2>üîç Model Details</h2>
        <div class="models-grid">
            <!-- LSTM Model -->
            <div class="model-card">
                <div class="model-header">
                    <h4>üß† LSTM Neural Network</h4>
                    <span class="model-status" id="lstmModelStatus">Loading</span>
                </div>
                <div id="lstmDetails">
                    <div class="metric-row">
                        <span class="metric-label">Sequence Length</span>
                        <span class="metric-value" id="lstmSequenceLength">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Features</span>
                        <span class="metric-value" id="lstmFeatures">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Buffer Size</span>
                        <span class="metric-value" id="lstmBufferSize">-</span>
                    </div>
                </div>
            </div>

            <!-- Ensemble Models -->
            <div class="model-card">
                <div class="model-header">
                    <h4>üé≤ Ensemble Models</h4>
                    <span class="model-status" id="ensembleModelStatus">Loading</span>
                </div>
                <div id="ensembleDetails">
                    <div class="metric-row">
                        <span class="metric-label">XGBoost</span>
                        <span class="metric-value" id="xgboostStatus">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">LightGBM</span>
                        <span class="metric-value" id="lightgbmStatus">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Random Forest</span>
                        <span class="metric-value" id="randomForestStatus">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">CatBoost</span>
                        <span class="metric-value" id="catboostStatus">-</span>
                    </div>
                </div>
            </div>

            <!-- Kelly Criterion -->
            <div class="model-card">
                <div class="model-header">
                    <h4>üéØ Kelly Criterion</h4>
                    <span class="model-status" id="kellyModelStatus">Loading</span>
                </div>
                <div id="kellyDetails">
                    <div class="metric-row">
                        <span class="metric-label">Max Kelly Fraction</span>
                        <span class="metric-value" id="maxKellyFraction">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Safety Multiplier</span>
                        <span class="metric-value" id="safetyMultiplier">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Min Confidence</span>
                        <span class="metric-value" id="minConfidence">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let autoRefreshEnabled = false;
let refreshInterval;

// Auto-refresh toggle
function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const indicator = document.getElementById('autoRefreshStatus');
    
    if (autoRefreshEnabled) {
        indicator.textContent = 'Auto-refresh: ON';
        indicator.classList.add('active');
        refreshInterval = setInterval(refreshAllData, 30000); // 30 seconds
        refreshAllData(); // Initial load
    } else {
        indicator.textContent = 'Auto-refresh: OFF';
        indicator.classList.remove('active');
        clearInterval(refreshInterval);
    }
}

// Start auto-refresh on page load
window.addEventListener('load', () => {
    toggleAutoRefresh(); // Start with auto-refresh enabled
});

// Refresh all dashboard data
async function refreshAllData() {
    try {
        await Promise.all([
            loadDashboardWidgets(),
            loadRecentPredictions(),
            loadModelDetails()
        ]);
        
        // Update last refresh time
        const now = new Date().toLocaleTimeString();
        console.log(`Dashboard refreshed at ${now}`);
        
    } catch (error) {
        console.error('Failed to refresh dashboard:', error);
    }
}

// Load dashboard widgets
async function loadDashboardWidgets() {
    try {
        const response = await fetch('/api/ml/dashboard/widgets');
        const data = await response.json();
        
        if (data.widgets) {
            updateStatusOverview(data.widgets.status_overview);
            updatePerformanceMetrics(data.widgets.performance_metrics);
            updateHealthAlerts(data.widgets.alerts_summary);
            updateRecentActivity(data.widgets.recent_activity);
        }
    } catch (error) {
        console.error('Failed to load dashboard widgets:', error);
    }
}

// Update status overview
function updateStatusOverview(status) {
    const lstmEl = document.getElementById('lstmStatus');
    const ensembleEl = document.getElementById('ensembleStatus');
    const kellyEl = document.getElementById('kellyStatus');
    
    updateStatusElement(lstmEl, status.lstm_status);
    updateStatusElement(ensembleEl, status.ensemble_status);
    updateStatusElement(kellyEl, status.kelly_status);
}

function updateStatusElement(element, status) {
    element.textContent = status.toUpperCase();
    element.parentElement.className = `status-item ${status}`;
}

// Update performance metrics
function updatePerformanceMetrics(metrics) {
    document.getElementById('totalPredictions').textContent = metrics.total_predictions || '-';
    document.getElementById('accuracy24h').textContent = metrics.accuracy_24h || '-';
    document.getElementById('avgConfidence').textContent = metrics.avg_confidence || '-';
    document.getElementById('agreementRate').textContent = metrics.agreement_rate || '-';
}

// Update health alerts
function updateHealthAlerts(alerts) {
    document.getElementById('totalAlerts').textContent = alerts.total_alerts || '0';
    
    const alertsList = document.getElementById('alertsList');
    if (alerts.total_alerts === 0) {
        alertsList.innerHTML = '<div style="color: #28a745; text-align: center; padding: 10px;">‚úÖ All systems healthy</div>';
    } else {
        alertsList.innerHTML = `
            <div style="font-size: 0.9em; color: #666;">
                üî¥ Critical: ${alerts.critical} | 
                üü° Warning: ${alerts.warning} | 
                üîµ Info: ${alerts.info}
            </div>
        `;
    }
}

// Update recent activity
function updateRecentActivity(activity) {
    const lastPred = activity.last_prediction ? 
        new Date(activity.last_prediction).toLocaleTimeString() : 'None';
    
    document.getElementById('lastPrediction').textContent = lastPred;
    document.getElementById('latestDirection').textContent = activity.latest_direction || '-';
    document.getElementById('latestConfidence').textContent = 
        activity.latest_confidence ? activity.latest_confidence.toFixed(2) : '-';
}

// Load recent predictions
async function loadRecentPredictions() {
    try {
        const response = await fetch('/api/ml/predictions/recent?limit=5');
        const data = await response.json();
        
        const container = document.getElementById('recentPredictions');
        
        if (data.predictions && data.predictions.length > 0) {
            container.innerHTML = data.predictions.map(pred => `
                <div class="prediction-item ${pred.direction}">
                    <div class="prediction-header">
                        <strong>${pred.symbol}</strong>
                        <span>${new Date(pred.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div>
                        Direction: <strong>${pred.direction.toUpperCase()}</strong> | 
                        Confidence: <strong>${(pred.confidence * 100).toFixed(1)}%</strong>
                        ${pred.models_agreement !== null ? 
                            ` | Agreement: <strong>${(pred.models_agreement * 100).toFixed(1)}%</strong>` : ''}
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${pred.confidence * 100}%"></div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No recent predictions available</div>';
        }
    } catch (error) {
        console.error('Failed to load recent predictions:', error);
        document.getElementById('recentPredictions').innerHTML = 
            '<div style="text-align: center; color: #dc3545; padding: 20px;">Failed to load predictions</div>';
    }
}

// Load model details
async function loadModelDetails() {
    try {
        // Load LSTM details
        const lstmResponse = await fetch('/api/ml/models/lstm/status');
        const lstmData = await lstmResponse.json();
        updateLSTMDetails(lstmData.lstm);
        
        // Load Ensemble details
        const ensembleResponse = await fetch('/api/ml/models/ensemble/status');
        const ensembleData = await ensembleResponse.json();
        updateEnsembleDetails(ensembleData.ensemble);
        
        // Load Kelly details
        const kellyResponse = await fetch('/api/ml/models/kelly/status');
        const kellyData = await kellyResponse.json();
        updateKellyDetails(kellyData.kelly);
        
    } catch (error) {
        console.error('Failed to load model details:', error);
    }
}

function updateLSTMDetails(lstm) {
    document.getElementById('lstmModelStatus').textContent = lstm.enabled ? 'ENABLED' : 'DISABLED';
    document.getElementById('lstmModelStatus').className = `model-status ${lstm.enabled ? 'enabled' : 'disabled'}`;
    
    document.getElementById('lstmSequenceLength').textContent = lstm.sequence_length || '-';
    document.getElementById('lstmFeatures').textContent = lstm.features || '-';
    document.getElementById('lstmBufferSize').textContent = lstm.data_buffer_size || '-';
}

function updateEnsembleDetails(ensemble) {
    document.getElementById('ensembleModelStatus').textContent = ensemble.enabled ? 'ENABLED' : 'DISABLED';
    document.getElementById('ensembleModelStatus').className = `model-status ${ensemble.enabled ? 'enabled' : 'disabled'}`;
    
    if (ensemble.models) {
        document.getElementById('xgboostStatus').textContent = ensemble.models.xgboost.trained ? '‚úÖ' : '‚ùå';
        document.getElementById('lightgbmStatus').textContent = ensemble.models.lightgbm.trained ? '‚úÖ' : '‚ùå';
        document.getElementById('randomForestStatus').textContent = ensemble.models.random_forest.trained ? '‚úÖ' : '‚ùå';
        document.getElementById('catboostStatus').textContent = ensemble.models.catboost.trained ? '‚úÖ' : '‚ùå';
    }
}

function updateKellyDetails(kelly) {
    document.getElementById('kellyModelStatus').textContent = kelly.enabled ? 'ENABLED' : 'DISABLED';
    document.getElementById('kellyModelStatus').className = `model-status ${kelly.enabled ? 'enabled' : 'disabled'}`;
    
    document.getElementById('maxKellyFraction').textContent = kelly.max_kelly_fraction || '-';
    document.getElementById('safetyMultiplier').textContent = kelly.safety_multiplier || '-';
    document.getElementById('minConfidence').textContent = kelly.min_confidence || '-';
}
</script>
{% endblock %}